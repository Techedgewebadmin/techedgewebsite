---
import Button from "@/components/ui/buttons/Button.astro";
import { actions } from 'astro:actions'; 
import { isInputError } from "astro:actions";

const result = Astro.getActionResult(actions.send);
const inputErrors = isInputError(result?.error) ? result.error.fields : {};
---

<form class="space-y-6" method="POST" id="contact-form">
  {result?.data && (
    <div class="p-4 bg-green-100 border-2 border-green-500 rounded-xl text-green-800">
      <p class="font-semibold">✓ Message sent successfully!</p>
    </div>
  )}
  
  {result?.error && !isInputError(result.error) && (
    <div class="p-4 bg-red-100 border-2 border-red-500 rounded-xl text-red-800">
      <p class="font-semibold">✗ {result.error.message}</p>
    </div>
  )}

  <!-- Messages container para JS -->
  <div id="form-message" class="hidden"></div>

  <!-- Honeypot field -->
  <input 
    type="text" 
    name="company" 
    style="position:absolute;left:-9999px;width:1px;height:1px;" 
    tabindex="-1" 
    autocomplete="off"
    aria-hidden="true"
  />

  <!-- Name Fields in Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div class="space-y-2">
      <label
        for="first-name"
        class="text-sm md:text-base font-grotesk font-medium uppercase text-muted"
      >
        First Name *
      </label>
      <input
        type="text"
        id="first-name"
        name="name"
        required
        placeholder="First Name"
        class="w-full px-4 py-3 bg-transparent border-b-2 border-muted focus:border-secondary outline-none transition-colors duration-300 placeholder:text-muted/50"
      />
      {inputErrors.name && (
        <p class="text-red-500 text-sm">{inputErrors.name}</p>
      )}
      <p class="text-red-500 text-sm hidden" data-error="name"></p>
    </div>

    <div class="space-y-2">
      <label
        for="last-name"
        class="text-sm md:text-base font-grotesk font-medium uppercase text-muted"
      >
        Last Name *
      </label>
      <input
        type="text"
        id="last-name"
        name="lastname"
        required
        placeholder="Last Name"
        class="w-full px-4 py-3 bg-transparent border-b-2 border-muted focus:border-secondary outline-none transition-colors duration-300 placeholder:text-muted/50"
      />
      {inputErrors.lastname && (
        <p class="text-red-500 text-sm">{inputErrors.lastname}</p>
      )}
      <p class="text-red-500 text-sm hidden" data-error="lastname"></p>
    </div>
  </div>

  <!-- Email -->
  <div class="space-y-2">
    <label
      for="email"
      class="text-sm md:text-base font-grotesk font-medium uppercase text-muted"
    >
      Email *
    </label>
    <input
      type="email"
      id="email"
      name="email"
      required
      placeholder="example@email.com"
      class="w-full px-4 py-3 bg-transparent border-b-2 border-muted focus:border-secondary outline-none transition-colors duration-300 placeholder:text-muted/50"
    />
    {inputErrors.email && (
      <p class="text-red-500 text-sm">{inputErrors.email}</p>
    )}
    <p class="text-red-500 text-sm hidden" data-error="email"></p>
  </div>

  <!-- Subject -->
  <div class="space-y-2">
    <label
      for="subject"
      class="text-sm md:text-base font-grotesk font-medium uppercase text-muted"
    >
      Subject *
    </label>
    <input
      type="text"
      id="subject"
      name="subject"
      required
      placeholder="How can we help?"
      class="w-full px-4 py-3 bg-transparent border-b-2 border-muted focus:border-secondary outline-none transition-colors duration-300 placeholder:text-muted/50"
    />
    {inputErrors.subject && (
      <p class="text-red-500 text-sm">{inputErrors.subject}</p>
    )}
    <p class="text-red-500 test-sm hidden" data-error="subject"></p>
  </div>

  <!-- Message -->
  <div class="space-y-2">
    <label
      for="message"
      class="text-sm md:text-base font-grotesk font-medium uppercase text-muted"
    >
      Project description *
    </label>
    <textarea
      id="message"
      name="message"
      rows="4"
      required
      placeholder="Tell us about your project..."
      class="w-full px-4 py-3 bg-transparent border-b-2 border-muted focus:border-secondary outline-none transition-colors duration-300 placeholder:text-muted/50 resize-none"
    ></textarea>
    {inputErrors.message && (
      <p class="text-red-500 text-sm">{inputErrors.message}</p>
    )}
    <p class="text-red-500 text-sm hidden" data-error="message"></p>
  </div>

  <!-- Submit Button -->
  <Button variant="solid" size="md" class="w-full md:w-auto px-12" id="submit-btn">
    <span id="btn-text">Submit</span>
    <span id="btn-loader" class="hidden">
      <svg class="animate-spin h-5 w-5 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Sending...
    </span>
  </Button>
</form>

<script>
  import { actions, isInputError } from 'astro:actions';

  const form = document.getElementById('contact-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const btnText = document.getElementById('btn-text');
  const btnLoader = document.getElementById('btn-loader');
  const formMessage = document.getElementById('form-message');

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault(); // IMPORTANT: Prevent default submit
      
      // Clear previous messages
      if (formMessage) {
        formMessage.classList.add('hidden');
        formMessage.innerHTML = '';
      }
      
      // Clear field errors
      document.querySelectorAll('[data-error]').forEach(el => {
        el.classList.add('hidden');
        el.textContent = '';
      });

      // Show loading state
      if (submitBtn && btnText && btnLoader) {
        submitBtn.disabled = true;
        btnText.classList.add('hidden');
        btnLoader.classList.remove('hidden');
      }

      try {
        const formData = new FormData(form);
        const { error } = await actions.send(formData);

        if (error) {
          // Show general error
          if (formMessage) {
            formMessage.classList.remove('hidden');
            formMessage.className = 'p-4 bg-red-100 border-2 border-red-500 rounded-xl text-red-800';
            formMessage.innerHTML = `<p class="font-semibold">✗ ${error.message}</p>`;
          }

          // If there are field validation errors
          if (isInputError(error)) {
            Object.entries(error.fields).forEach(([field, messages]) => {
              const errorEl = document.querySelector(`[data-error="${field}"]`);
              if (errorEl && Array.isArray(messages)) {
                errorEl.classList.remove('hidden');
                errorEl.textContent = messages[0];
              }
            });
          }
        } else {
          // Show success message
          if (formMessage) {
            formMessage.classList.remove('hidden');
            formMessage.className = 'p-4 bg-green-100 border-2 border-green-500 rounded-xl text-green-800';
            formMessage.innerHTML = '<p class="font-semibold">✓ Message sent successfully!</p>';
          }
          
          // Reset form
          form.reset();
          
          // Scroll to success message
          formMessage?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      } catch (err) {
        console.error('Form submission error:', err);
        if (formMessage) {
          formMessage.classList.remove('hidden');
          formMessage.className = 'p-4 bg-red-100 border-2 border-red-500 rounded-xl text-red-800';
          formMessage.innerHTML = '<p class="font-semibold">✗ An unexpected error occurred. Please try again.</p>';
        }
      } finally {
        // Restore buttons
        if (submitBtn && btnText && btnLoader) {
          submitBtn.disabled = false;
          btnText.classList.remove('hidden');
          btnLoader.classList.add('hidden');
        }
      }
    });
  }
</script>
