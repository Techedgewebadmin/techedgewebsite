---
import Button from "../buttons/Button.astro";
import { FullscreenMenu } from "./FullscreenMenu";
---

<nav
  id="navbar"
  class="fixed top-1 left-2 right-2 md:left-12 md:right-12 z-40 transition-all duration-300"
>
  <div
    id="navbar-inner"
    class="w-full mx-auto px-4 md:px-9 py-6 flex justify-between items-center transition-all duration-500"
  >
    <!-- Logo -->
    <a href="/" class="flex items-center z-10">
      <img
        src="/images/logo.webp"
        alt="Cipres Logo"
        class="w-20 md:w-28 h-auto transition-transform duration-300 hover:scale-110"
      />
    </a>

    <!-- Right Side Buttons -->
    <div class="flex items-center gap-4">
      <!-- Let's Talk Button (visible on scroll, hidden on mobile) -->
      <Button
        id="lets-talk-btn"
        variant="primary"
        href="/contact"
        class="hidden md:flex opacity-0 pointer-events-none text-base px-6 py-3"
      >
        Let's Talk
      </Button>

      <!-- Menu Button -->
      <Button
        id="menu-toggle"
        variant="secondary"
        class="cursor-pointer flex items-center gap-3 px-6 py-3 group"
        aria-label="Toggle menu"
      >
        <span
          class="hidden md:block font-grotesk font-semibold text-sm md:text-base uppercase"
          >Menu</span
        >
        <div class="grid grid-cols-2 gap-1">
          <div class="size-1.5 rounded-full bg-current"></div>
          <div class="size-1.5 rounded-full bg-current"></div>
          <div class="size-1.5 rounded-full bg-current"></div>
          <div class="size-1.5 rounded-full bg-current"></div>
        </div>
      </Button>
    </div>
  </div>

  <!-- Background Overlay (only visible on scroll) -->
  <div
    id="navbar-bg"
    class="absolute inset-0 -z-10 opacity-0 transition-opacity duration-300 bg-muted border-b-2 border-secondary max-w-360 mx-auto rounded-xl"
  >
  </div>
</nav>

<!-- Fullscreen Menu -->
<FullscreenMenu client:load />

<script>
  import { gsap } from "gsap";

  const navbarInner = document.getElementById("navbar-inner");
  const navbarBg = document.getElementById("navbar-bg");
  const letsTalkBtn = document.getElementById("lets-talk-btn");
  const menuToggle = document.getElementById("menu-toggle");
  let isMenuOpen = false;
  let isScrolled = false;
  let isInitialized = false;

  // Function to set the initial state without animation
  const initNavbar = () => {
    const scrollY = window.scrollY;

    if (scrollY > 80) {
      // Set scrolled state immediately without animation
      gsap.set(navbarInner, {
        maxWidth: "90rem",
        paddingTop: "1rem",
        paddingBottom: "1rem",
      });

      gsap.set(navbarBg, {
        opacity: 1,
      });

      gsap.set(letsTalkBtn, {
        opacity: 1,
        pointerEvents: "auto",
        x: 0,
      });

      isScrolled = true;
    } else {
      // Set initial state immediately without animation
      gsap.set(navbarInner, {
        maxWidth: "100%",
        paddingTop: "1.5rem",
        paddingBottom: "1.5rem",
      });

      gsap.set(navbarBg, {
        opacity: 0,
      });

      gsap.set(letsTalkBtn, {
        opacity: 0,
        pointerEvents: "none",
        x: 20,
      });

      isScrolled = false;
    }

    isInitialized = true;
  };

  const updateNavbar = () => {
    if (!isInitialized) return;

    const scrollY = window.scrollY;

    if (scrollY > 80 && !isScrolled) {
      isScrolled = true;

      // Timeline for scroll animation
      const tl = gsap.timeline();

      // Animate the internal container to max-w-7xl
      tl.to(navbarInner, {
        maxWidth: "90rem",
        paddingTop: "1rem",
        paddingBottom: "1rem",
        duration: 0.4,
        ease: "power3.out",
      });

      // Fade in the background
      tl.to(
        navbarBg,
        {
          opacity: 1,
          duration: 0.3,
          ease: "power2.out",
        },
        "-=0.3"
      );

      // Show "Let's Talk" button
      tl.to(
        letsTalkBtn,
        {
          opacity: 1,
          pointerEvents: "auto",
          x: 0,
          duration: 0.3,
          ease: "back.out(1.2)",
        },
        "-=0.2"
      );
    } else if (scrollY <= 80 && isScrolled) {
      isScrolled = false;

      // Timeline to return to the initial state
      const tl = gsap.timeline();

      // Hide "Let's Talk" button
      tl.to(letsTalkBtn, {
        opacity: 0,
        pointerEvents: "none",
        x: 20,
        duration: 0.2,
        ease: "power2.in",
      });

      // Fade out the background
      tl.to(
        navbarBg,
        {
          opacity: 0,
          duration: 0.3,
          ease: "power2.in",
        },
        "-=0.1"
      );

      // Animate the container back to full width
      tl.to(
        navbarInner,
        {
          maxWidth: "100%",
          paddingTop: "1.5rem",
          paddingBottom: "1.5rem",
          duration: 0.4,
          ease: "power3.out",
        },
        "-=0.3"
      );
    }
  };

  // Initialize navbar state on page load
  initNavbar();

  // Throttled scroll listener
  let ticking = false;
  window.addEventListener("scroll", () => {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        updateNavbar();
        ticking = false;
      });
      ticking = true;
    }
  });

  // Menu toggle
  menuToggle?.addEventListener("click", () => {
    isMenuOpen = !isMenuOpen;

    // Dispatch custom event to React component
    window.dispatchEvent(
      new CustomEvent("toggleMenu", { detail: { isOpen: isMenuOpen } })
    );
  });

  // Listen for menu close from React
  window.addEventListener("closeMenu", () => {
    isMenuOpen = false;
  });
</script>

<style>
  #navbar {
    transform-origin: top center;
  }

  /* Asegurar que el navbar-inner se centre cuando est√° en max-w-7xl */
  #navbar-inner {
    margin-left: auto;
    margin-right: auto;
  }

  /* Menu button pulse animation on hover */
  #menu-toggle:hover .grid {
    animation: pulse 0.6s ease-in-out;
  }

  @keyframes pulse {
    0%,
    100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.2);
    }
  }

  /* Smooth transition for Let's Talk button */
  #lets-talk-btn {
    transform: translateX(20px);
  }
</style>
